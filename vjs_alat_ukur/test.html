<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="../1.asset/main.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../3.utility/auth.js"></script>
    <link rel="icon" href="../1.asset/symbol/new_logo_sbe.png" type="image/ico" />
    <title>VJS alat ukur</title>
</head>
<body class="font-[Poppins] h-[100vh] w-[100vw] bg-slate-300 flex-row custom_scroll">
        <div class='loading z-20'></div>
<script type="module">
    // all Import module
    import {
        button,
        addButton,
        minusButton,
        dtlist,
        textInput,
        hiddenInput,
        loading,
        header,
        main,
        section,
        aside,
        div,
        customTable,
        createTh,
        createTr,
        createTd,
        td_input,
        td_button,
        td_select,
        td_radio,
        text,
        custom_table,
        form,
        navigation,
        searchbar,
        selectionRow,
        selectionCol,
        table,
        inputTable,
        inputEmptyRow,
    } from '../1.asset/index.js';
    import {mainTable, secondTable} from '../1.asset/index.js';
    import {
        //proses
        delete_cache,cache,get_cache,
        showDelBtn, del_process,
        dl_process,
        insertUpdateProcess,
        searchProcess,
        numberToStr, 
        currentDate,
        curDate,
        jsonToCsv,
        jsonToExcel,
        convertDateFormat,
        getCustomDate,
        activeLink,
        activeLink2,
        removeSpaces,
    } from '../3.utility/index.js';
    import {navArr,
            master,
            point,
            reff,
            vjs_log, 
    } from './general.js';

    // navigation
    navigation('VJS Alat Ukur', navArr)

    // header
    header('fixed flex flex-col top-[5vh] bg-slate-700 w-screen h-[18vh]');
        const alat_detail = await master.dbProcess('get','');
        await dtlist('tool_list', '_', alat_detail, 'sn_id', 'new_subcat', '_desc', 'loc');
        div('main_search', 'header','flex flex-row w-full');
        text({target: `#main_search`, text: 'Pilih Alat', ID: 'labelMain', style:'pl-8 text-lg font-semibold text-white mt-3 w-[18vw]'})
        textInput({target:`#main_search`, text: 'pilih alat', ID:'pickAlat', style:'rounded px-4 ml-4 text-lg h-[1.6rem] mt-3 w-[70vw]', dtlist: 'tool_list'});
        const header_main = [
            {divID: 'card1', text:'Deskripsi Alat', ID: 'desc'},
            {divID: 'card2', text:'Kategori', ID: 'cat'},
            {divID: 'card3', text:'No Seri', ID: 'no_seri'},
            {divID: 'card3', text:'Lokasi', ID: 'lokasi'},
        ]
        header_main.forEach(dt=>{
            div(dt.divID, 'header','flex flex-row w-full');
            text({target: `#${dt.divID}`, text: dt.text, ID: dt.ID, style:'pl-8 w-[20vw] text-lg mt-3 text-white'})
            textInput({target: `#${dt.divID}`, disable:'true', ID:dt.ID, data:dt.text, style:'w-[80vw] bg-transparent text-white text-xl font-bold mt-3'});
        })
        const bodyDiv = document.querySelector('body');
        bodyDiv.removeChild(document.querySelector('.loading'));    
        

    // main

    main('fixed flex flex-row top-[23vh] bg-slate-300 w-full h-[77vh]');
        let filterValue = document.querySelector('[data-input = "input__pickAlat"]');
        let no_seri = document.querySelector('[data-input = "input__no_seri"]');
        let cat_alat = document.querySelector('[data-input = "input__cat"]');
        let desc_alat = document.querySelector('[data-input = "input__desc"]');
        let location = document.querySelector('[data-input = "input__lokasi"]');
        let cek = '';
        let vjs_trans = []; // data transaction
        let check_point =[]; // data point pengecekan 
        const user = JSON.parse(sessionStorage.getItem("userData"));
        const mainTag = document.querySelector('main');



    // event listener
    // change event listener
     document.addEventListener('change', async function(event) {
        if(event.target.getAttribute('data-input') === 'input__pickAlat') {
            if(document.querySelector('[data-table]') !== null) {
                const allTable = document.querySelectorAll('[data-table]');
                allTable.forEach(dt=>{
                    if(!dt.classList.contains('hidden')) {
                        dt.classList.toggle('hidden');
                    }
                })
            }
            mainTag.appendChild(await loading('loading'));
            filterValue = event.target.value;
            let splitValue = filterValue.split('__');
            no_seri.value = splitValue[0];
            cat_alat.value = splitValue[1];
            desc_alat.value = splitValue[2];
            location.value = splitValue[3];
            if(document.querySelector(`[data-table ="${splitValue[0]}"]`) !== null) {
                const tableTarget = document.querySelector(`[data-table ="${splitValue[0]}"]`);
                tableTarget.classList.toggle('hidden');
            }
            vjs_trans = await vjs_log.dbProcess('fetch',{sn_id: no_seri.value});
            cek = vjs_trans.find(obj=> obj.trans_date === currentDate());
            console.log({vjs_trans, cek});
            if(!cek || vjs_trans.length === 0 ||cek === undefined) {
                check_point = await point.dbProcess('fetch',{new_cat: cat_alat.value, status:1});
                console.log(check_point);
                check_point.forEach(dt=>{
                    const data = {
                        aprroval_by: "",
                        category: dt.new_cat,
                        check_point: dt.check_point,
                        data_group: curDate("")+vjs_trans[0].sn_id,
                        decision: "",
                        no_asset:vjs_trans[0].no_asset,
                        result: "NG",
                        sn_id: splitValue[0],
                        standard: dt.standard,
                        trans_date: currentDate(),
                        user_input: user.name + "-" + user.jabatan + "-" + user.dept + "-" + user.grade,
                    }
                    vjs_trans.push(data);
                })
                console.log(vjs_trans)
            }
            vjs_trans.sort((a,b) => {
                if (a.trans_date !== b.trans_date) return b.trans_date.localeCompare(a.trans_date);
                if (a.check_point === 'remark') return -1; // Move remarks to the beginning
                if (b.check_point === 'remark') return 1; // Move remarks to the beginning
                return a.check_point.localeCompare(b.check_point);
            })

            if(document.querySelector('#tableDiv') === null) {
                div('tableDiv', 'main', 'w-full h-full scrollable')
            }

            customTable({target: '#tableDiv',tableID: no_seri.value});
            createTh({
                target:`[data-table = "${no_seri.value}"]`,
                th: [
                    {text: 'Date'},
                    {text:'User'},
                    {text:'Approved By'},
                    {text:''},
                ]
            })
            let date_check = '';
            let counter = 0;
            vjs_trans.forEach(dt=>{
                const filter = dt.trans_date + no_seri.value + cat_alat.value;
                if(date_check !== dt.trans_date) {
                    date_check = dt.trans_date;
                    mainTable(dt, filter);
                    createTh({
                            target:`[data-table = "${dt.sn_id}"]`,
                            trStyle : 'hidden',
                            defaultStyle:'bg-slate-400 border-2 font-semibold capitalize border-black p-2 sticky top-[9vh] z-10',
                            ID: `detail_${dt.data_group}__header`,
                            th: [
                                {text:'Poin Pengecekan'},
                                {text:'Standard'},
                                {text:'Hasil Cek'},
                            ]
                        })
                } else {
                    secondTable(dt,filter);
                }
            })
            mainTag.removeChild(document.querySelector('.loading'));  
            return;
        }
        if(event.target.type === 'radio') {
            const trgt = event.target;
            const name = trgt.getAttribute('name');
            const td = document.querySelector(`[data-td *="${name}"]`);
            const span = td.querySelector('span');
            if(!span.classList.contains('minus')) {
                td.classList.toggle('bg-teal-400');
                span.classList.toggle('check');
                td.classList.toggle('bg-red-300');
                span.classList.toggle('cross');
            } else {
                span.classList.toggle('minus');
                if(trgt.id.includes('opt1')) {
                    td.classList.toggle('bg-teal-400');
                    span.classList.toggle('check');
                } else {
                    td.classList.toggle('bg-red-300');
                    span.classList.toggle('cross');
                }
            }
            const tr = trgt.closest('tr');
            const valueGroup = tr.getAttribute('data-tr').split('_');
            tr.setAttribute('data-change', 'change');
            const btn = document.querySelector(`[data-field = "submit__${valueGroup[1]}"]`);
            if (btn.disabled === true) {
                btn.disabled = false;
                btn.classList.toggle('hover:w-8');
                btn.classList.toggle('hover:h-8');
            }
            return;
        }
        if(event.target.type === 'text' ) {
            console.log('testing');
            const trgt = event.target;
            const tr = trgt.closest('tr');
            tr.setAttribute('data-change', 'change');
            const dataAll = tr.querySelectorAll('td');
            console.log({tr});
            console.log({splitValue})
            //const data = {
            //    aprroval_by: "",
            //    category: dt.new_cat,
            //    check_point: dt.check_point,
            //    data_group: curDate("")+vjs_trans[0].sn_id,
            //    decision: "",
            //    no_asset:vjs_trans[0].no_asset,
            //    result: "NG",
            //    sn_id: splitValue[0],
            //    standard: dt.standard,
            //    trans_date: currentDate(),
            //    user_input: user.name + "-" + user.jabatan + "-" + user.dept + "-" + user.grade,
            //}
            return;
        }
    })

    // click event listener
    document.addEventListener('click', async function(event) {
        if(event.target.tagName === 'BUTTON') {
            if(event.target.getAttribute('data-field').includes('openBtn__')) {
                const btn = event.target;
                const data_group = event.target.getAttribute('data-field');
                const split = data_group.split("__");
                btn.classList.toggle('open');
                btn.classList.toggle('hide');
                const targetDiv = document.querySelectorAll(`[data-tr *="detail_${split[1]}"]`);
                targetDiv.forEach(dt=>{
                    dt.classList.toggle('hidden');
                })
                const target = curDate('') + split
                const targetMain = document.querySelectorAll(`[data-tr ="${split[1]}"]`);
                targetMain.forEach(dt=>{
                    const td = dt.querySelectorAll('td');
                    td.forEach(dt=>{
                        dt.classList.toggle('bg-blue-300')
                        dt.classList.toggle('bg-teal-200')
                    })
                })

                return;
            }
        }
    })

    // keydown event listener
    document.addEventListener('keydown', function(event) {
        if (event.key === "Enter") {
            const submit_btn = document.querySelector('#search_btn__pick_now');
            submit_btn.click();
        }
    })
</script>
<script src="../assets/template/library/sheetjs/xlsx.full.min.js"></script>
</body>
</html>