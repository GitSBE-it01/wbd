<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="./component/main.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="./utility/auth.js"></script>
    <link rel="icon" href="../NEW-LOGO-SBE.png" type="image/ico" />
    <title>VJS alat ukur</title>
</head>
<body class="font-[Poppins] h-[100vh] w-[100vw] bg-slate-300 flex-row custom_scroll">
        <div class='loading z-20'></div>
<script type="module">
    // all Import module
    import {
        button,
        addButton,
        minusButton,
        dtlist,
        textInput,
        hiddenInput,
        loading,
        header,
        main,
        section,
        aside,
        div,
        customTable,
        createTh,
        createTr,
        createTd,
        td_input,
        td_button,
        td_select,
        text,
        form,
        navigation,
        searchbar,
        selectionRow,
        selectionCol,
        table,
        inputTable,
        inputEmptyRow,
    } from './component/index.js';

    import {
        //proses
        delete_cache,cache,get_cache,
        showDelBtn, del_process,
        dl_process,
        insertUpdateProcess,
        searchProcess,
        numberToStr, 
        currentDate,
        curDate,
        jsonToCsv,
        jsonToExcel,
        convertDateFormat,
        getCustomDate,
        activeLink,
        activeLink2,
        removeSpaces,
        //class
        master,
        point,
        reff,
        vjs_log, 
    } from './utility/index.js';
    import {navArr} from './general.js';

    // navigation
    navigation('VJS Alat Ukur', navArr)

    // header
    header('fixed flex flex-col top-[5vh] bg-slate-700 w-screen h-[18vh]');
        const alat_detail = await master.dbProcess('get','');
        await dtlist('tool_list', '_', alat_detail, 'sn_id', 'new_subcat', '_desc', 'loc');
        div('main_search', 'header','flex flex-row w-full');
        text({target: `#main_search`, text: 'Pilih Alat', ID: 'labelMain', style:'pl-8 text-lg font-semibold text-white mt-3 w-[18vw]'})
        textInput({target:`#main_search`, text: 'pilih alat', ID:'pickAlat', style:'rounded px-4 ml-4 text-lg h-[1.6rem] mt-3 w-[70vw]', dtlist: 'tool_list'});
        const header_main = [
            {divID: 'card1', text:'Deskripsi Alat', ID: 'desc'},
            {divID: 'card2', text:'Kategori', ID: 'cat'},
            {divID: 'card3', text:'No Seri', ID: 'no_seri'},
            {divID: 'card3', text:'Lokasi', ID: 'lokasi'},
        ]
        header_main.forEach(dt=>{
            div(dt.divID, 'header','flex flex-row w-full');
            text({target: `#${dt.divID}`, text: dt.text, ID: dt.ID, style:'pl-8 w-[20vw] text-lg mt-3 text-white'})
            textInput({target: `#${dt.divID}`, disable:'true', ID:dt.ID, data:dt.text, style:'w-[80vw] bg-transparent text-white text-xl font-bold mt-3'});
        })
        const bodyDiv = document.querySelector('body');
        bodyDiv.removeChild(document.querySelector('.loading'));    
        

    // main
    main('fixed flex flex-row top-[23vh] bg-slate-300 w-full h-[77vh]');
        let filterValue = document.querySelector('[data-input = "input__pickAlat"]');
        let no_seri = document.querySelector('[data-input = "input__no_seri"]');
        let cat_alat = document.querySelector('[data-input = "input__cat"]');
        let desc_alat = document.querySelector('[data-input = "input__desc"]');
        let location = document.querySelector('[data-input = "input__lokasi"]');
        let cek = '';
        let vjs_trans = []; // data transaction
        let check_point =[]; // data point pengecekan 



    // event listener
    // change event listener
     document.addEventListener('change', async function(event) {
        if(event.target.getAttribute('data-input') === 'input__pickAlat') {
            filterValue = event.target.value;
            let splitValue = filterValue.split('__');
            console.log({splitValue})
            no_seri.value = splitValue[0];
            cat_alat.value = splitValue[1];
            desc_alat.value = splitValue[2];
            location.value = splitValue[3];
            console.log('no seri',no_seri.value);
            vjs_trans = await vjs_log.dbProcess('fetch',{sn_id: no_seri.value});
            vjs_trans.sort((a,b) => {
                if (a.check_point === 'remark') return -1; // Move remarks to the beginning
                if (b.check_point === 'remark') return 1; // Move remarks to the beginning
                if (a.trans_date !== b.trans_date) return b.trans_date.localeCompare(a.trans_date);
                return a.check_point.localeCompare(b.check_point);
            })
            console.log({vjs_trans});
            cek = vjs_trans.find(obj=> obj.trans_date === currentDate());
            console.log({cek});
            if(!cek) {
                check_point = await point.dbProcess('fetch',{new_cat: cat_alat.value});
                console.log({check_point});
            }

            customTable({target: 'main',tableID: no_seri.value});
            createTh({
                target:`[data-table = "${no_seri.value}"]`,
                th: [
                    {text: 'Date'},
                    {text:'User'},
                    {text:'Approved By'},
                    {text:''},
                ]
            })
            let date_check = '';
            vjs_trans.forEach(dt=>{
                const filter = dt.trans_date + no_seri.value + cat_alat.value;
                if(date_check !== dt.trans_date) {
                    date_check = dt.trans_date;
                    createTr({target:`[data-table = "${no_seri.value}"]`,id: dt.data_group,filter: filter});
                        createTd({target: `[data-tr = "${dt.data_group}"]`, field: 'trans_date',style:'bg-blue-300 border-2 text-lg border-black px-2 sticky top-[4vh] z-10', text:dt.trans_date });
                        createTd({target: `[data-tr = "${dt.data_group}"]`, field:'user_input',style:'bg-blue-300 border-2 text-lg border-black px-2 sticky top-[4vh] z-10', text:dt.user_input});
                        createTd({target: `[data-tr = "${dt.data_group}"]`, field:`approval_by`,style:'bg-blue-300 h-full border-2 text-lg border-black px-2 sticky top-[4vh] z-10 justify-right', text:dt.approval_by});
                        createTd({target: `[data-tr = "${dt.data_group}"]`, style:'bg-blue-300 h-full border-2 text-lg border-black px-2 sticky top-[4vh] z-10 justify-right', id: `openHide__${dt.data_group}`});
                            td_button({target: `[data-td = "openHide__${dt.data_group}"]`, style: 'open sticky top-[4vh] z-10 mt-[.3rem] w-8 h-8'})
                    createTh({
                        target:`[data-table = "${no_seri.value}"]`,
                        defaultStyle:'bg-slate-400 border-2 font-semibold capitalize border-black p-2 sticky top-[9vh] z-10',
                        ID: `${dt.data_group}__ThDetail"]`,
                        th: [
                            {text:'Poin Pengecekan'},
                            {text:'Standard'},
                            {text:'Hasil Cek'},
                        ]
                    })
                } else {
                    console.log('here');
                    createTr({target:`[data-table = "${no_seri.value}"]`,id: `detail_${dt.data_group}__${dt.check_point}`, filter:filter,});
                        createTd({target: `[data-tr = "detail_${dt.data_group}__${dt.check_point}`, field: 'check_point', text: dt.check_point });
                        createTd({target: `[data-tr = "detail_${dt.data_group}__${dt.check_point}`, field: 'standard', text: dt.standard});
                        createTd({target: `[data-tr = "detail_${dt.data_group}__${dt.check_point}`,id: `result__${dt.data_group}__${dt.check_point}`, style: 'bg-slate-100 border-2 text-sm border-black' });
                            td_input({
                                target: `[data-td="result__${dt.data_group}__${dt.check_point}"]`,
                                field: dt.result, 
                                
                            })
                    }
                })
            return;
        }
    })

    // click event listener
    document.addEventListener('click', async function(event) {
        if(event.target.getAttribute('data-filter')) {

            return;
        }
    })

    // keydown event listener
    document.addEventListener('keydown', function(event) {
        if (event.key === "Enter") {
            const submit_btn = document.querySelector('#search_btn__pick_now');
            submit_btn.click();
        }
    })
</script>
<script src="../assets/template/library/sheetjs/xlsx.full.min.js"></script>
</body>
</html>